# ✅ 테스트 케이스 & QA 플랜 — Studio Morph (MVP Lite)

본 문서는 PRD/TRD/ERD/API Spec/Rules/요금 유틸을 기반으로 **MVP 품질 보증**을 위해 작성된 테스트 전략과 케이스 모음입니다.

---

## 0) 목표 & 범위

* **목표**: 1인 운영자가 오류 없이 월간 정산을 진행할 수 있도록 핵심 기능의 신뢰성 확보
* **범위**: 예약 동기화/보정, 요금 엔진, CSV 파싱, 매칭 추천/수동 확정, 비용 입력, 대시보드 요약, 목표 알림(이메일)

---

## 1) 테스트 유형

* **단위(Unit)**: 요금 엔진, 시간 분할, 할인, 연락처 정규화, CSV 파서
* **통합(Integration)**: Storage Trigger→bankTx 생성, Functions→invoices 생성, 매칭 플로우
* **E2E(End-to-End)**: 캘린더 동기화→예약 보정→인보이스→CSV→매칭→대시보드 반영→목표 알림
* **수용(Acceptance/UAT)**: 운영자 시나리오 기준 기능/UX 확인
* **회귀(Regression)**: 핵심 플로우 체크리스트 자동화
* **접근성(A11y)**: 키보드 내비게이션, 라벨, 컬러 대비
* **성능/부하**: CSV 2천건 파싱, 대시보드 요약 시간
* **보안**: Rules 우회 불가, 비인가 쓰기 차단

---

## 2) 테스트 환경

* **Firebase 프로젝트**: `studio-morph-dev` (dev), `studio-morph-prod` (prod)
* **데이터베이스**: Firestore (Asia-Northeast3)
* **스토리지**: `/bank-csv/*` 버킷 경로
* **메일**: SendGrid sandbox (또는 Firebase Extensions Trigger Email 테스트 모드)
* **시드 데이터**: 캘린더 샘플 20건, CSV 샘플 100건

---

## 3) 테스트 데이터(픽스처)

* **예약**

  * R1: 2025-10-12 19:00~21:00, people=4 (경계 교차)
  * R2: 2025-10-12 22:00~2025-10-13 02:00, people=3 (跨日)
  * R3: 2025-10-09 10:00~14:00, people=5 (주간+추가인원)
  * R4: 2025-10-12 18:00~21:00, 19:30부터 people=5 (인원 변경)
* **CSV(입금)**

  * T1: 2025-10-12 21:30, 70,000, depositor="김모씨" (R1 후보)
  * T2: 2025-10-13 02:05, 80,000, depositor="무명" (R2 후보)
  * T3: 2025-10-09 14:10, 200,000, depositor="윤아영" (R3 후보)
  * T4: 2025-05-07 23:07, 160,000, depositor="김준석(뉴머)" (과거 데이터, 불일치)

---

## 4) 단위 테스트 케이스 (발췌)

### 4.1 요금 엔진

1. **경계 혼합** R1

* 입력: 19–21, 4인, 할인 없음
* 기대: base 60,000 + extra 10,000 = **70,000**

2. **跨日** R2

* 입력: 22–02, 3인
* 기대: 4h * 20,000 = **80,000**

3. **인원 변경** R4

* 입력: 18–19:30(3인), 19:30–20:00(5인, DAY), 20:00–21:00(5인, NIGHT)
* 기대: base 100,000 + extra 15,000 = **115,000**

4. **비율 할인**

* 입력: R3 + rate 10%
* 기대: 200,000 → 180,000

5. **금액 할인**

* 입력: R3 + amount 15,000
* 기대: 200,000 → 185,000

6. **최소 시간 위반**

* 입력: 09–10 (1h)
* 기대: 에러 `MIN_DURATION_NOT_MET`

7. **동시 할인 금지**

* 입력: rate+amount 동시
* 기대: 에러 `DISCOUNT_CONFLICT`

### 4.2 유틸/정규화

* 연락처: `010-1234-5678` → `01012345678`
* 시간 파싱: `13-16`, `13:00~16:00`, `1시~4시` → 24h 정규화
* CSV 금액/일자 포맷 정규화

---

## 5) 통합 테스트 케이스

1. **CSV 업로드 → bankTx 생성**

* 동작: `/bank-csv/T1.csv` 업로드
* 기대: `bankTx` 문서 생성(status=`UNMATCHED`), 필드 정규화

2. **캘린더 Pull → reservations 생성**

* 동작: Scheduler 또는 수동 트리거
* 기대: R1~R4 생성, meta 파싱(연락처 필수), `needsCorrection` 적절 표시

3. **인보이스 생성**

* 동작: `createInvoice(reservationId)`
* 기대: `invoices` 문서 생성, 금액 일치

4. **매칭 추천**

* 동작: `listPendingMatches`
* 기대: T1→R1, T2→R2, T3→R3 상위 추천

5. **수동 매칭 확정**

* 동작: `matchBankTx(txId, invoiceId)`
* 기대: bankTx.status=`MATCHED`, invoice.linked, 중복 매칭 방지

---

## 6) E2E 시나리오

### 6.1 기본 정산 플로우

1. 캘린더 이벤트 생성(R3) → 동기화
2. 예약 상세 보정(연락처 확인) → 인보이스 생성
3. CSV 업로드(T3) → 매칭 추천 확인
4. 수동 매칭 → 대시보드 요약 반영
5. 월 목표 입력(600만) → 목표 대비 게이지
6. 월말 알림(미달 시 이메일)

### 6.2 예외/보정 플로우

* 연락처 누락 예약 → `needsCorrection` 큐에서 보정 후 인보이스 생성
* 동일 금액 2건 입금 → 자동 매칭 보류, 매칭 큐에서 수동 지정
* 跨日 예약 + 인원 변경 포함 계산 검증

---

## 7) 접근성(A11y) 체크리스트

* 모든 인터랙티브 요소 `aria-label` 제공
* 키보드 포커스 순서 자연스러움(Tab)
* 색상 대비 4.5:1 이상, 색상만으로 상태 전달 금지(아이콘/텍스트 병행)
* 모달 열림 시 포커스 트랩, ESC로 닫힘

---

## 8) 성능/부하 테스트

* **CSV 2,000건** 업로드: 파싱 ≤ 10초(Function 메모리 512MB)
* 대시보드 요약 쿼리: 캐시된 `summaries` 조회 ≤ 200ms
* 예약 리스트 페이징: 50건/페이지, 페이지 전환 ≤ 300ms

---

## 9) 보안/권한 테스트

* 비인증 사용자의 읽기/쓰기 차단 (Firestore/Storage Rules)
* 클라이언트에서 invoices/bankTx 직접 쓰기 시도 → 차단 확인
* OWNER_UID 계정만 R/W 허용 확인

---

## 10) 버그 리포팅 & 우선순위

* **버그 템플릿**: 재현 절차, 실제/기대 결과, 스크린샷, 로그 ID, 환경(dev/prod)
* **우선순위 기준**

  * P0: 데이터 손실/금액 오류/보안 이슈 → 즉시 수정 후 재배포
  * P1: 정산 불가(매칭/인보이스 생성 실패)
  * P2: UX 결함/느린 응답
  * P3: 경미한 UI 오류/오탈자

---

## 11) 릴리스 기준(Exit Criteria)

* 단위/통합/E2E 주요 케이스 **100% 통과**
* 회귀 검증 체크리스트 100% 통과
* 보안/권한 테스트 통과
* 핵심 성능 지표 만족 (CSV 파싱 ≤10s, 요약 조회 ≤200ms)

---

## 12) 자동화 권장 사항

* GitHub Actions: `npm test`(shared-pricing), Functions 유닛 테스트, Lint/TypeCheck
* Playwright/Cypress: 주요 E2E(매칭 플로우, 인보이스 생성, 대시보드)
* Lighthouse: 접근성/성능 측정 (대시보드 최소 90점 목표)

---

## 13) 체크리스트 (요약)

* [ ] 예약 최소 2시간 검증
* [ ] 경계/跨日/인원 변경 합산 정확
* [ ] 금액/비율 할인 택1 강제
* [ ] CSV 파싱 포맷 변형 허용
* [ ] 추천 매칭 상위 정확
* [ ] 수동 매칭 충돌 방지
* [ ] 목표 알림 1일 1회 디바운스
* [ ] 접근성 키보드/라벨/대비 OK
* [ ] Rules: 비인증 차단/Functions 전용 쓰기 차단
